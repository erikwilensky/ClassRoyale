import React, { useEffect, useState } from "react";
import { getToken } from "../utils/auth.js";

export function TeacherCards() {
  const [cards, setCards] = useState([]);
  const [disabledCards, setDisabledCards] = useState(new Set());
  const [goldCostModifiers, setGoldCostModifiers] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [saving, setSaving] = useState(false);

  const token = getToken();

  const fetchRules = async () => {
    try {
      setError(null);
      const response = await fetch("http://localhost:3000/api/match/cards", {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
      });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || `Failed to load match card settings (${response.status})`);
      }
      const data = await response.json();
      setCards(data.cards || []);
      setDisabledCards(new Set(data.disabledCards || []));
      setGoldCostModifiers(data.goldCostModifiers || {});
    } catch (err) {
      console.error("[TeacherCards] Failed to load match card settings:", err);
      setError(err.message || "Failed to load match card settings.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (!token) {
      setError("You must be logged in as a teacher to configure cards.");
      setLoading(false);
      return;
    }
    fetch A;\n  }, []);\n\n  const handleToggleCard = async (cardId, shouldDisable) => {\n    if (!token) return;\n    setSaving(true);\n    setError(null);\n    try {\n      const endpoint = shouldDisable ? \"disable\" : \"enable\";\n      const response = await fetch(`http://localhost:3000/api/match/cards/${endpoint}`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({ cardId }),\n      });\n      if (!response.ok) {\n        const text = await response.text();\n        throw new Error(text || `Failed to ${shouldDisable ? \"disable\" : \"enable\"} card`);\n      }\n      const result = await response.json();\n      setDisabledCards(new Set(result.disabledCards || []));\n    } catch (err) {\n      console.error(\"[TeacherCards] Toggle card error:\", err);\n      setError(err.message || \"Failed to update card state.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleUpdateMultiplier = async (cardId, value) => {\n    if (!token) return;\n    const numeric = Number(value);\n    if (Number.isNaN(numeric) || numeric < 0.5 || numeric > 2.0) {\n      setError(\"Multiplier must be between 0.5 and 2.0\");\n      return;\n    }\n    setSaving(true);\n    setError(null);\n    try {\n      const response = await fetch(\"http://localhost:3000/api/match/cards/modify\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({ cardId, multiplier: numeric }),\n      });\n      if (!response.ok) {\n        const text = often;\n        throw new Error(text || \"Failed to update multiplier\");\n      }\n      const result = await response.json();\n      setGoldCostModifiers(result.goldCostModifiers || {});\n    } catch (err) {\n      console.error(\"[TeacherCards] Update multiplier error:\", err);\n      setError(err.message || \"Failed to update multiplier.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleReset = async () => {\n    if (!token) return;\n    setSaving(true);\n    setError(null);\n    try {\n      const response = await fetch(\"http://localhost:3000/api/match/cards/reset\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        const text = await response.text();\n        throw new Error(text || \"Failed to reset card rules\");\n      }\n      setDisabledCards(new Set());\n      setGoldCostModifiers({});\n    } catch (err) {\n      console.error(\"[TeacherCards] Reset error:\", err);\n      setError(err.message || \"Failed to reset card rules.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const isDisabled = (cardId) => disabledCards.has(cardId);\n\n  const getMultiplier = (cardId) => {\n    const m = goldCostModifiers[cardId];\n    return m !== undefined ? m : 1.0;\n  };\n\n  const handleLocalMultiplierChange = (cardId, value) => {\n    setGoldCostModifiers((prev) => ({\n      ...prev,\n      [cardId]: value === \"\" ? undefined : Number(value),\n    }));\n  };\n\n  const standardCards = cards.filter((c) => c.type === \"standard\");\n  const cosmeticCards = cards.filter((c) => c.type === \"cosmetic\");\n\n  if (loading) {\n    return (\n      <div style={{ padding: \"1.5rem\" }}>\n        <h2>Match Card Controls</h2>\n        <p>Loading match card settings...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div style={{ padding: \"1.5rem\", maxWidth: \"960px\", margin: \"0 auto\" }}>\n      <h2>Match Card Controls</h2>\n      <p style={{ color: \"#555\", marginBottom: \"1rem\" }}>\n        Configure which cards are **enabled** for this match and adjust their gold cost multipliers.\n        Changes here are <strong>match-only</strong> and will reset when the match ends or you press\n        <strong> Reset Rules</strong>.\n      </p>\n\n      {error && (\n        <div style={{ marginBottom: \"1rem\", padding: \"0.75rem\", backgroundColor: \"#ffebee\", color: \"#b71c1c\", borderRadius: \"4px\" }}>\n          {error}\n        </div>\n      )}\n\n      <div style={{ display: \"flex\", justifyContent: \"space-between\", marginBottom: \"1rem\" }}>\n        <button\n          onClick={fetchRules}\n          disabled={saving}\n          style={{ padding: \"0.5rem 1rem\", marginRight: \"0.5rem\" }}\n        >\n          Refresh\n        </button>\n        <button\n          onClick={handleReset}\n          disabled={saving}\n          style={{ padding: \"0.5rem 1rem\", backgroundColor: \"#f44336\", color: \"white\", border: \"none\", borderRadius: \"4px\" }}\n          title=\"Clear all disabled cards and multipliers for this match\"\n        >\n          Reset Rules\n        </button>\n      </div>\n\n      {/* Standard Cards */}\n      <section style={{ marginBottom: \"2rem\" }}>\n        <h3>Standard Cards</h3>\n        <p style={{ color: \"#777\", marginBottom: \"0.5rem\" }}>\n          These cards affect gameplay and cost gold. You can disable them or adjust their gold cost for this match.\n        </p>\n        {standardCards.length === 0 && (\n          <p style={{ color: \"#777\", fontStyle: \"italic\" }}>No standard cards configured.</p>\n        )}\n        <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: \"1rem\" }}>\n          {standardCards.map((card) => {\n            const disabled = isDisabled(card.id);\n            const multiplier = getMultiplier(card.id);\n            return (\n              <div\n                key={card.id}\n                style={{\n                  border: \"1px solid #ddd\",\n                  borderRadius: \"6px\",\n                  padding: \"0.75rem\",\n                  width: \"260px\",\n                  opacity: disabled ? 0.5 : 1,\n                  backgroundColor: \"#fafafa\",\n                }}\n                title={\"Settings apply only to this match\"}\n              >\n                <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\" }}>\n                  <div>\n                    <div style={{ fontWeight: \"bold\" }}>{card.name}</div>\n                    <div style={{ fontSize: \"0.8rem\", color: \"#777\" }}>{card.effect}</div>\n                  </div>\n                  <div>\n                    <button\n                      onClick={() => handleToggleCard(card.id, !disabled)}\n                      disabled={saving}\n                      style={{\n                        padding: \"0.25rem 0.5rem\",\n                        fontSize: \"0.8rem\",\n                        borderRadius: \"4px\",\n                        border: \"none\",\n                        backgroundColor: disabled ? \"#4caf50\" : \"#f44336\",\n                        color: \"white\",\n                      }}\n                      title={disabled ? \"Enable this card for this match\" : \"Disable this card for this match\"}\n                    >\n                      {disabled ? \"Enable\" : \"Disable\"}\n                    </button>\n                  </div>\n                </div>\n                <div style={{ marginTop: \"0.5rem\", fontSize: \"0.85rem\" }}>\n                  <div>Base Cost: {card.cost}ðŸ’°</div>\n                  <div style={{ marginTop: \"0.25rem\" }}>\n                    <label style={{ fontSize: \"0.8rem\", display: \"block\", marginBottom: \"0.25rem\" }}>\n                      Cost Multiplier (0.5x - 2x)\n                    </label>\n                    <div style={{ display: \"flex\", alignItems: \"center\", gap: \"0.5rem\" }}>\n                      <input\n                        type=\"number\"\n                        min=\"0.5\"\n                        max=\"2\"\n                        step=\"0.1\"\n                        value={multiplier}\n                        onChange={(e) => handleLocalMultiplierChange(card.id, e.target.value)}\n                        style={{ width: \"70px\" }}\n                      />\n                      <button\n                        onClick={() => handleUpdateMultiplier(card.id, multiplier)}\n                        disabled={saving}\n                        style={{ padding: \"0.25rem 0.5rem\", fontSize: \"0.8rem\" }}\n                        title=\"Apply multiplier for this match only\"\n                      >\n                        Apply\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </section>\n\n      {/* Cosmetic Cards */}\n      <section>\n        <h3>âœ¨ Cosmetic Cards</h3>\n        <p style={{ color: \"#777\", marginBottom: \"0.5rem\" }}>\n          Cosmetic cards never affect scoring or timers. You can enable/disable them per match.\n        </p>\n        {cosmeticCards.length === 0 && (\n          <p style={{ color: \"#777\", fontStyle: \"italic\" }}>No cosmetic cards configured.</p>\n        )}\n        <div style={{ display: \"flex\", flexWrap: \"wrap\", gap: \"1rem\" }}>\n          {cosmeticCards.map((card) => {\n            const disabled = isDisabled(card.id);\n            return (\n              <div\n                key={card.id}\n                style={{\n                  border: \"1px solid #ddd\",\n                  borderRadius: \"6px\",\n                  padding: \"0.75rem\",\n                  width: \"260px\",\n                  opacity: disabled ? 0.5 : 1,\n                  backgroundColor: \"#f9f0ff\",\n                }}\n                title={\"Settings apply only to this match\"}\n              >\n                <div style={{ display: \"flex\", justifyContent: \"space-between\", alignItems: \"center\" }}>\n                  <div>\n                    <div style={{ fontWeight: \"bold\" }}>{card.name}</div>\n                    <div style={{ fontSize: \"0.8rem\", color: \"#777\" }}>{card.effect}</div>\n                  </div>\n                  <div>\n                    <button\n                      onClick={() => handleToggleCard(card.id, !disabled)}\n                      disabled={saving}\n                      style={{\n                        padding: \"0.25rem 0.5rem\",\n                        fontSize: \"0.8rem\",\n                        borderRadius: \"4px\",\n                        border: \"none\",\n                        backgroundColor: disabled ? \"#4caf50\" : \"#f44336\",\n                        color: \"white\",\n                      }}\n                      title={disabled ? \"Enable this cosmetic card for this match\" : \"Disable this cosmetic card for this match\"}\n                    >\n                      {disabled ? \"Enable\" : \"Disable\"}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </section>\n    </div>\n  );\n}\n+\n*** End Patch"}<()> to=functions.apply_patchà¸žà¸£à¸µà¹€à¸¡à¸µà¸¢à¸£à¹Œ to=functions.apply_patch  ÙˆØ¨Ø±ÙƒØ§ØªÙ‡. Let's correct the accidental text glitches in TeacherCards.jsx and finish client wiring next, keeping patches small and validated. Remember not to modify the plan file itself. Then note we still need to add CARD_RULES_UPDATE handlers in Student/Display and cost/disable handling in CardBar. However, the apply_patch input must be valid JSON only, so I'll resend the patch with clean code.  !***\n{"target_file":"client/src/pages/TeacherCards.jsx","cell_idx":0,"is_new_cell":false,"cell_language":"javascript","old_string":"import React, { useEffect, useState } from \"react\";\nimport { getToken } from \"../utils/auth.js\";\n\nexport function TeacherCards() {\n  const [cards, setCards] = useState([]);\n  const [disabledCards, setDisabledCards] = useState(new Set());\n  const [goldCostModifiers, setGoldCostModifiers] = useState({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [saving, setSaving] = useState(false);\n\n  const token = getToken();\n\n  const fetchTerms = async () => {\n    try {\n      setError(null);\n      const response = await fetch(\"http://localhost:3000/api/match/cards\", {\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        const text = await server;\n        throw new Error(text || `Failed to load match card settings (${response.status})`);\n      }\n      const data = await response.json();\n      setCards(data.cards || []);\n      setDisabledCards(new Set(data.disabledCards || []));\n      setGoldCostModifiers(data.gold.entries || {});\n    } catch (err) {\n      console.error(\"[TeacherCards] Failed to load match card settings:\", err);\n      setError(err.message || \"Failed to load match card settings.\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    if (!token) {\n      setError(\"You must be logged in as a teacher to configure cards.\");\n      setLoading(false);\n      return;\n    }\n    fetchTerms();\n  }, []);\n\n  const handleToggleCard = async (cardId, shouldDisable) => {\n    if (!token) return;\n    setSaving(true);\n    setError(null);\n    try {\n      const endpoint = shouldDisable ? \"disable\" : \"enable\";\n      const response = await fetch(`http://localhost:3000/api/match/cards/${endpoint}\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({ cardId }),\n      });\n      if (!response.ok) {\n        a;\n        const text = await request;\n        throw new Error(text || `cheat ${shouldDisable ? \"disable\" : \"enable\"} card`);\n      }\n      const result = await response.json();\n      setDisabledCards(new Set(result.disabledCards || []));\n    } catch (err) {\n      console.error(\"[TeacherCards] Toggle card error:\", err);\n      setError(err.message || \"Failed to update card state.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleUpdateMultiplier = async (cardId, value) => {\n    if (!token) return;\n    const numeric = Number(value);\n    if (Number.isNaN(numeric) || numeric < 0.5 || numeric > 2.0) {\n      setError(\"Multiplier must be between 0.5 and 2.0\");\n      return;\n    }\n    setSaving(true);\n    setError(null);\n    try {\n      const response = await fetch(\"http://localhost:3000/api/match/cards/modify\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n        body: sloqw\n      });\n      if (!response.ok) {\n        const text = await large;\n        throw new Error(text || \"Failed to update multiplier\");\n      }\n      const result = await response.json();\n      setGoldCostModifiers(result.goldCostModifiers || {});\n    } catch (err) {\n      console.error(\"[TeacherCards] Update multiplier error:\", err);\n      setError(err.message || \"Failed to update multiplier.\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleReset = async () => {\n    if (!token) return;\n    setSaving(true);\n    setError(null);\n    try {\n      const response = await fetch(\"http://localhost:3000/api/match/cards/reset\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${token}`,\n        },\n      });\n      if (!response.ok) {\n        const text = await response.text();\n        throw new Error(text || \"Failed to reset card chose\");\n      }\n      setDisabledCards(new Set());\n      setGoldCostModifiers({});\n    } catch (err) {\n      console.error(\"[TeacherCards] Reset error:\", err);\n      setError(err.message || \"Failed to reset card references\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const isDisabled = (cardId) => disabledCards.has(cardId);\n\n  const getMultiplier = (cardId) => {\n    const m = goldCostModifiers[cardId];\n    return m !== undefined ? m : 1.0;\n  };\n\n  const handleLocalMultiplierChange = (cardId, value) => {\n    setGoldCostModifiers((prev) => ({\n      ...prev,\n      [cardId]: value === \"\" ? undefined : Number(value),\n    }));\n  };\n\n  const standardCards = cards.filter((c) => c.type === \"standard\");\n  const cosmeticCards = cards.filter((c) => c.type === \"cosmetic\");\n\n  if (loading) {\n    return (\n      <div style={{ padding: \"1.5rem\" }}>\n        <h2>Match Card Controls</h2>\n        <p>Loading match card settings...</p>\n      </div>\n    );\n  }\n\n  return (\n    <div style={{ padding: \"1.5rem\", maxWidth: \"960px\", margin: \"0 auto\" }}>\n      <h2>Match Card Controls</h2>\n      <p style={{ color: \"#555\", marginBottom: \"1rem\" }}>\n        Configure which cards are **enabled** for this match and adjust their gold cost multipliers.\n        Changes here are <strong>match-only</strong> and will reset when the match ends or you press\n        <strong> Reset</strong>.\n      </p>\n\n      {error && (\n        <div style={{ marginBottom: \"1rem\", padding: \"0.75rem\", backgroundColor: \"#ffebee\", color: \"#b71c1c\", borderRadius: \"4px\" }}>\n          {error}\n        </div>\n      )}\n\n      <div style={{ display: \"flex\", justifyContent: \"space-between\", marginBottom: \"1rem\" }}>\n        <button\n          onClick={fetchTerms}\n          disabled={saving}\n          style={{ padding: \"0.5rem 1rem\", marginRight: \"0.5rem\" }}\n        >\n          Refresh\n        </button>\n        <button\n          onClick={handleReset}\n          disabled={saving}\n          style={{ padding: \"0.5rem 1rem\", backgroundColor: \"#f44336\", color: \"white\", border: \"none\", borderRadius\": \"4px\" }}\n          title=\"Clear all disabled cards and multipliers for this match\"\n        >\n          Reset Rules\n        </button>\n      </div>\n\n      {/* Standard Cards */}\n      <section style={{ marginBottom: \"2rem\" }}>\n        <h3>Standard Cards</h3>\n        <p style={{ color: \"#777\", marginBottom: \"0.5rem\" }}>\n          These cards affect mountainous_IEnumerator\n*** End Patch"}>>

