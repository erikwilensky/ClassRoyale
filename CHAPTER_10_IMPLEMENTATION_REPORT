Chapter 10 – Card Shop & Persistent Meta‑Progression Implementation Report 1. Goals & Constraints Goals Add a persistent XP-driven meta-progression system. Implement a card shop where players unlock cards with XP. Make cards and cosmetics persistent across matches. Ensure the system is fair: no pay-to-win, only balanced advantages and cosmetics. Hard Constraints Match fairness must be preserved (no runaway dominance from unlocks). No question/match result persistence beyond XP and unlocks. Shop accessible only outside matches (lobby/main menu). Unlock operations must be atomic and auth‑guarded. No schema edit in place; migrations done via the existing migrations path. 2. Data Model & Persistence 2.1 Player Progress (XP) Where: Extended existing players table via server/db/migrations.js. Fields xp INTEGER DEFAULT 0 – total lifetime XP. availableXP INTEGER DEFAULT 0 – spendable XP balance for shop purchases. Semantics xp: monotonically non-decreasing; reflects total earned XP. availableXP: increases when XP is awarded, decreases when spent in shop. 2.2 Card Data & Unlocks Card definitions: server/config/cards.js Central, single source of truth for all card definitions. Each card entry: { id: "SHAKE", name: "Shake", unlockCost: 100, // XP cost to unlock in shop type: "standard", // "standard" | "cosmetic" cost: 3, // gold cost in-match (standard only) target: "opponent" | "self", effect: "Description/effect type", description: "UI-friendly description" } Types standard: gameplay-impacting, uses in‑match gold, must be unlocked to cast. cosmetic: visual-only, no gold cost, must be unlocked to use. Key Design Choice All card metadata centralized here so: Shop, CardBar, and server logic share the same schema. Easy to rebalance XP costs & gold costs without touching logic. Player unlocks Persisted via existing/unified unlock structure, surfaced through: DB helpers (through xpService and shop routes). client.metadata.unlockedCards on join to QuizRoom. 3. XP Flow & Services 3.1 XP Awarding & Flushing Where: server/services/xpService.js and server/QuizRoom.js. Mechanism During the match, XP is accumulated in-memory in xpCache per player: addXPToCache(playerId, amount, reason) At key points (round end, match end, manual end, etc.): flushAllXP() is called. It: Sums cache.totalXP. Writes to DB: Increments xp (total XP). Increments availableXP. Returns new totals and any unlocks. Sends XP_EARNED message to all non-display clients for that player. Award Sources Participation, round winner, match winner, MVP, card cast, etc. Controlled in QuizRoom.awardScoringXP and related code. Chapter 10 made sure both xp and availableXP are updated in DB. 3.2 Spending XP Function: spendXP(playerId, amount) in xpService.js Atomically checks: Player exists. availableXP >= amount. Deducts XP from availableXP. Returns new balance or error. Used exclusively from shop purchase route to ensure atomicity. 3.3 Player Progress Endpoint Route: GET /api/player/progress Where: server/routes/player.js (mounted in server/index.js as /api/player) Request Requires JWT-auth; reads playerId from token. Response totalXP availableXP unlockedCards (array of card IDs) Client Shop.jsx uses this to render current balances and unlock state. 4. Card Shop – Server-Side 4.1 Routes & Mounting File: server/routes/shop.js Mount: in server/index.js as: app.use("/api/shop", shopRoutes); app.use("/api/player", playerRouter); Exports setShopQuizRoomInstance used to share the active QuizRoom instance for certain server-side awareness if needed. 4.2 Endpoints GET /api/shop/cards Authenticated. Returns: cards: full list of CARDS with metadata. Optionally, can indicate which cards are unlocked for that player on server-side; the client merges with player progress. POST /api/shop/purchase Body: { cardId }. Steps: Auth: verify JWT & extract playerId. Match Guard: ensure player is not in an active QuizRoom match (no purchases mid-match). Validate Card: Card exists in CARDS. Not already unlocked for that player. unlockCost > 0. Atomic Operation: Begin transaction. Call spendXP(playerId, card.unlockCost): If insufficient XP, abort with error. Insert unlock record / update player’s unlocked list. Commit transaction. Return: Updated availableXP. Updated unlockedCards. GET /api/player/progress As described above: returns XP balances and unlocked cards. Used by Shop.jsx and potentially other meta UIs. 5. Card Shop – Client-Side 5.1 Routing & Access File: client/src/main.jsx Added route for "/shop" that renders Shop.jsx. Access Control Shop page requires user to be logged in (via existing auth flow). Listed in student navigation via Student.jsx with a “Shop” entry. 5.2 Shop.jsx Responsibilities Fetch player progress from GET /api/player/progress. Fetch card list from GET /api/shop/cards. Render: Top section: Total XP, Available XP. Card grid: Grouped by type: Standard vs Cosmetic. Status: Owned -> “Owned” / disabled buy button. Unowned & affordable -> “Unlock for X XP” (enabled). Unowned & not affordable -> disabled with tooltip. Handle purchase actions: Call POST /api/shop/purchase. On success: Update availableXP. Update unlockedCards. Trigger small UI animation (e.g., highlight / flash). On error: Show error message banner or toast. Error Fix Implemented Initially Shop.jsx called /api/shop/progress which didn’t exist. Updated to http://localhost:3000/api/player/progress, matching server route. 5.3 ShopCard.jsx Single-card component responsible for: Displaying card name, description, type, unlock cost, and standard cost. Showing locked/unlocked state. Showing cosmetic badge vs standard card styling. Emitting onPurchase when clicked (if enabled). 6. In-Match Card Usage (CardBar & QuizRoom) 6.1 CardBar.jsx – Client Purpose Shows all cards a player can see in-match. Distinguishes between: Standard cards: cost gold, can target self or opponents. Cosmetic cards: free in match, must be unlocked, purely visual. Data Fetching Fetches cards from /api/shop/cards. Uses getToken() from auth.js (fixing earlier inconsistency using localStorage.getItem("token")). Rendering Rules Shows all cards, not only unlocked: For locked cards: button disabled with title “Unlock for X XP in Shop”. Layout: Standard cards grouped under “Standard Cards”. Cosmetic cards under “✨ Cosmetic Cards”. Button state: Disabled if: Round not active. Not enough gold (gold < card.cost) for standard cards. Invalid target for opponent cards (self-target error). Card not owned (for both standard & cosmetic). Tooltips describe why a card is disabled. Click Behaviour Logs [CardBar] Card clicked: ... with card info. Standard vs cosmetic: Standard: uses gold & sends castCard with targetTeamId. Cosmetic: sends castCard but doesn’t cost gold; purely visual. Calls handleCastCard in Student.jsx. 6.2 Student.jsx – Client Handler: handleCastCard(cardId, targetTeamId) Guards: Must have room. Must have teamId. Must be in roundActive state. Logs debug info: [Student] handleCastCard called: ... If blocked, logs reason (no room / no team / round not active). Sends room.send("castCard", { cardId, targetTeamId }) to server. 6.3 QuizRoom.js – Server castCard Handler Eligibility & Team Lookup Rejects if client is not a student or is a display. Finds team by: SessionId OR writerPlayerId (playerId) for reconnect safety, OR suggesters membership. If team not found: Logs team details for debugging. Sends ERROR: "You are not in a team". Unlock Check If client.metadata.unlockedCards absent: Loads from DB: getPlayerUnlockedCards(playerId). Validates that: unlockedCards is an array. cardId is included. Rejects with ERROR: "Card not unlocked" otherwise. Cosmetic Cards Bypass gold check. Create a light CARD_CAST event with isCosmetic: true. Do not manipulate state beyond broadcasting effect. Standard Cards Require: Sufficient team.gold >= card.cost. Valid target: For target: "opponent": non-self, existing team. Deduct gold and update state.gold. Instantiate an EffectState object: cardId, casterTeamId, targetTeamId, timestamp, expiresAt. Store in state.activeEffects. Award +1 XP via addXPToCache(playerId, 1, "cardCast"). Broadcast CARD_CAST and update gold/team state. 7. Re-introducing Legacy Cards (Shake, Blur, Overclock, Distract) User Request Restore classic cards SHAKE, BLUR, and OVERCLOCK (and logically related DISTRACT) into the new Chapter 10 architecture. Implementation File: server/config/cards.js Added as standard cards with moderate XP unlock costs and gold cost: SHAKE type: "standard", target: "opponent", unlockCost: 100, cost: 3. Effect: briefly scrambles opponent’s answer text. BLUR type: "standard", target: "opponent", unlockCost: 80, cost: 2. Effect: blurs opponent’s view for a short duration. DISTRACT type: "standard", target: "self", unlockCost: 60, cost: 1. Effect: adds a small time bonus to the team’s timer. OVERCLOCK type: "standard", target: "opponent", unlockCost: ~220, cost: 4. Effect: speeds up opponent timer temporarily. Outcome These cards: Appear in Shop with XP costs. Appear in CardBar in-match. Respect the new unlock and gold systems. 8. Authentication, Match Guarding & Fairness Authentication All shop and player progress endpoints require a valid JWT. playerId is always derived from the token, never from the client request body. Match Guarding POST /api/shop/purchase checks that the player is not in an active match. Ensures you cannot change competitive loadout mid-game. Fairness Considerations All unlockable standard cards: Have non‑overwhelming effects. Use gold as a limiting resource. Are designed to create tactical variety, not raw power escalation. Cosmetics are strictly visual and free to use once unlocked. XP is skill & participation based, no purchases or random loot. 9. Bugs Encountered & Fixes (Chapter 10) 9.1 Shop Failing to Load Symptom Client error: “Failed to load shop. Please try again.” Cause Shop.jsx fetched player progress from /api/shop/progress while server exposed /api/player/progress. Fix Mounted playerRouter at /api/player. Updated Shop.jsx to call /api/player/progress. 9.2 Collected Answers Regressed Symptom Teacher showed "(No answer submitted)" for all teams even when answers existed. Causes lockAnswer not always updating team.answer. Teacher UI using ROUND_ENDED.teams[].answer, which could drift. Fixes QuizRoom.lockAnswer: Better logging. Ensured team.answer is updated and non-null strings used. QuizRoom.endRound: Logged per-team answers and lengths. Stored canonical answers per round in this.answers and ROUND_DATA. Teacher.jsx ROUND_DATA handler: Uses message.answers snapshot as the canonical answer source. Always creates an entry for each team; uses (No answer submitted) only when text is empty. 9.3 Cards Not Showing / Not Casting Symptoms CardBar rendered only label “Cards” or no cards. Cards visible but: No gold deducted. No effects triggered. Causes CardBar: Inconsistent token retrieval. Old hardcoded list, not using the new /api/shop/cards. QuizRoom: client.metadata.unlockedCards sometimes uninitialized. Team lookup for castCard could fail on reconnect. Fixes CardBar.jsx: Uses getToken() and /api/shop/cards. Renders all cards with clear locked/unlocked states. Added detailed logs for clicks and card resolution. QuizRoom.castCard: Loads unlockedCards from DB when missing. Adds verbose logs through team lookup, unlock checks, gold checks, and effect creation. Later extended to use writerPlayerId as fallback in team detection (to better handle reconnects). 9.4 restart.sh Logs Visibility Symptom Using restart.sh hid logs in /tmp files. Fix Modified restart.sh to: By default: run server and client in background without redirecting output, so logs are visible in the terminal. --background flag: preserves old behavior with log redirection to /tmp. 10. Summary & Current Status What Chapter 10 added A persistent XP + unlock system. A full card shop with server and client endpoints. Integration of standard and cosmetic cards across: Database REST API Lobby/meta UI (/shop) In‑match UI (CardBar) Server-side enforcement (castCard). Restored legacy cards SHAKE, BLUR, DISTRACT, and OVERCLOCK within the new system. Fairness & UX Competitive fairness preserved: XP is effort-based. Cards are balanced and gold‑limited. Cosmetics are non‑competitive. UX: Clear shop statuses. Clear in‑match availability & tooltips. XP feedback during and after matches.